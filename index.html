<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>◊™◊§◊®◊ô◊ò ◊™◊ê◊ô ◊¶◊§◊ô◊ô◊î - ◊î◊¶◊ë◊¢◊î</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&family=Rubik:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { margin: 0; padding: 0; font-family: 'Heebo', 'Rubik', sans-serif; direction: rtl; background: linear-gradient(165deg, #fafafa 0%, #f0f0f0 100%); min-height: 100vh; }

    @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-8px); } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

    .loading-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background: #1a1a2e; }
    .loading-spinner { font-size: 48px; animation: spin 1s linear infinite; }

    .header { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); padding: 40px 20px 30px; text-align: center; }
    .header-emoji { font-size: 42px; animation: float 3s ease-in-out infinite; display: inline-block; }
    .header h1 { font-family: 'Rubik', sans-serif; font-size: 28px; font-weight: 800; color: #fff; margin: 12px 0 4px; letter-spacing: -0.5px; }
    .header-sub { color: #E63946; font-size: 16px; font-weight: 600; margin-bottom: 14px; }
    .header-badge { display: inline-flex; align-items: center; gap: 6px; background: rgba(230,57,70,0.15); color: #fff; padding: 6px 16px; border-radius: 20px; font-size: 13px; font-weight: 500; border: 1px solid rgba(230,57,70,0.3); }

    .section { padding: 16px 16px 0; max-width: 600px; margin: 0 auto; }

    .name-label { display: block; font-size: 15px; font-weight: 600; color: #333; margin-bottom: 8px; margin-top: 20px; }
    .name-input { width: 100%; padding: 12px 16px; font-size: 16px; border-radius: 12px; border: 2px solid #e0e0e0; font-family: 'Heebo', sans-serif; background: #fff; direction: rtl; text-align: right; transition: all 0.2s ease; }
    .name-input:focus { outline: none; border-color: #E63946; box-shadow: 0 0 0 3px rgba(230,57,70,0.15); }

    .voted-banner { display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 14px 16px; margin: 16px auto 0; max-width: 568px; background: linear-gradient(135deg, #d4edda, #c3e6cb); border-radius: 14px; font-size: 15px; font-weight: 600; color: #155724; text-align: center; }

    .results-toggle { width: 100%; padding: 10px 16px; margin-top: 12px; background: rgba(26,26,46,0.08); border: none; border-radius: 10px; font-size: 14px; font-weight: 600; color: #333; cursor: pointer; font-family: 'Heebo', sans-serif; transition: background 0.2s; }
    .results-toggle:hover { background: rgba(26,26,46,0.14); }

    .common-banner { margin: 16px auto 8px; padding: 16px 18px; max-width: 568px; background: #fff; border-radius: 16px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); }
    .common-title { font-size: 16px; font-weight: 700; color: #1a1a2e; margin-bottom: 10px; }
    .common-item { font-size: 13px; color: #555; padding: 4px 0; display: flex; align-items: center; gap: 6px; }

    .cards-grid { display: flex; flex-direction: column; gap: 14px; padding: 12px 16px; max-width: 600px; margin: 0 auto; }

    .menu-card { border-radius: 18px; box-shadow: 0 2px 16px rgba(0,0,0,0.07); overflow: hidden; position: relative; background: #fff; border: 3px solid transparent; transition: all 0.3s cubic-bezier(0.4,0,0.2,1); cursor: pointer; }
    .menu-card:hover { transform: translateY(-4px); box-shadow: 0 12px 40px rgba(0,0,0,0.15); }

    .winner-badge { position: absolute; top: 12px; left: 12px; background: linear-gradient(135deg, #FFD700, #FFA500); color: #fff; font-size: 11px; font-weight: 700; padding: 4px 10px; border-radius: 8px; z-index: 2; box-shadow: 0 2px 8px rgba(255,165,0,0.3); }
    .my-vote-badge { position: absolute; top: 12px; left: 12px; color: #fff; font-size: 11px; font-weight: 700; padding: 4px 10px; border-radius: 8px; z-index: 2; }

    .card-header { padding: 18px 18px 10px; }
    .card-top { display: flex; align-items: center; gap: 12px; }
    .menu-emoji-box { width: 52px; height: 52px; border-radius: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 28px; }
    .card-title-area { flex: 1; text-align: right; }
    .menu-name { font-size: 17px; font-weight: 700; color: #1a1a2e; font-family: 'Rubik', sans-serif; margin-bottom: 4px; }
    .category-badge { font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 6px; display: inline-block; }
    .expand-icon { font-size: 12px; color: #aaa; padding: 8px; background: none; border: none; cursor: pointer; transition: transform 0.3s ease; }
    .main-dish { font-size: 14px; color: #666; font-weight: 500; margin-top: 10px; padding-top: 8px; border-top: 1px solid #f0f0f0; }

    .vote-bar-container { position: relative; height: 24px; background: #f0f0f0; border-radius: 12px; margin-top: 10px; overflow: hidden; }
    .vote-bar { position: absolute; top: 0; right: 0; height: 100%; border-radius: 12px; transition: width 0.8s cubic-bezier(0.4,0,0.2,1); }
    .vote-count { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 11px; font-weight: 700; color: #333; direction: ltr; }
    .voter-names { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    .voter-chip { font-size: 11px; font-weight: 500; padding: 2px 8px; border-radius: 6px; border: 1px solid; background: rgba(255,255,255,0.8); }

    .expanded-content { padding: 0 18px 8px; animation: slideUp 0.3s ease; }
    .detail-section { margin-bottom: 10px; }
    .detail-label { font-size: 13px; font-weight: 700; color: #444; margin-bottom: 4px; }
    .detail-text { font-size: 13px; color: #666; line-height: 1.6; }
    .side-item { font-size: 13px; color: #666; padding: 2px 0; }

    .vote-btn { width: calc(100% - 36px); margin: 4px 18px 16px; padding: 12px 16px; border-radius: 12px; color: #fff; font-size: 15px; font-weight: 700; font-family: 'Heebo', sans-serif; border: none; cursor: pointer; box-shadow: 0 4px 14px rgba(0,0,0,0.15); transition: all 0.2s ease; display: block; }
    .vote-btn:hover:not(:disabled) { transform: scale(1.03); filter: brightness(1.1); }
    .vote-btn:active:not(:disabled) { transform: scale(0.97); }
    .vote-btn:disabled { cursor: not-allowed; }

    .footer { text-align: center; padding: 30px 16px 10px; color: #888; font-size: 12px; opacity: 0.6; }

    /* ‚îÄ‚îÄ Admin dashboard ‚îÄ‚îÄ */
    .admin-wrap { max-width: 640px; margin: 0 auto; padding: 24px 16px 40px; }
    .admin-total { text-align: center; font-size: 15px; color: #888; margin-bottom: 24px; }
    .admin-total strong { color: #1a1a2e; font-size: 22px; }
    .admin-empty { text-align: center; color: #aaa; font-size: 16px; padding: 60px 0; }
    .admin-row { background: #fff; border-radius: 16px; box-shadow: 0 2px 12px rgba(0,0,0,0.07); padding: 16px 20px; margin-bottom: 14px; }
    .admin-row-top { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
    .admin-rank { font-size: 20px; width: 32px; text-align: center; flex-shrink: 0; }
    .admin-emoji { font-size: 26px; width: 40px; text-align: center; flex-shrink: 0; }
    .admin-name { font-size: 16px; font-weight: 700; color: #1a1a2e; flex: 1; font-family: 'Rubik', sans-serif; }
    .admin-count { font-size: 18px; font-weight: 800; flex-shrink: 0; }
    .admin-bar-bg { height: 18px; background: #f0f0f0; border-radius: 9px; overflow: hidden; margin-bottom: 10px; }
    .admin-bar-fill { height: 100%; border-radius: 9px; transition: width 1s cubic-bezier(0.4,0,0.2,1); }
    .admin-chips { display: flex; flex-wrap: wrap; gap: 6px; }
    .admin-chip { font-size: 12px; font-weight: 500; padding: 3px 10px; border-radius: 8px; border: 1.5px solid; background: rgba(255,255,255,0.9); }
    .admin-refresh { display: block; margin: 0 auto 20px; padding: 8px 22px; background: rgba(26,26,46,0.07); border: none; border-radius: 10px; font-size: 13px; font-weight: 600; font-family: 'Heebo',sans-serif; color: #444; cursor: pointer; transition: background 0.2s; }
    .admin-refresh:hover { background: rgba(26,26,46,0.13); }
  </style>
</head>
<body>

<div id="app"></div>

<script>
const BLOB_ID = "019c85ea-9ebd-7424-ad89-10d7582d12f0";
const BLOB_URL = "https://jsonblob.com/api/jsonBlob/" + BLOB_ID;

const MENUS = [
  { id:1, name:"◊ê◊û◊®◊ô◊ß◊î üçî", emoji:"üá∫üá∏", color:"#E63946", main:"◊î◊û◊ë◊ï◊®◊í◊®◊ô◊ù 180 ◊í◊®◊ù", description:"◊î◊û◊ë◊ï◊®◊í◊®◊ô◊ù ◊¢◊°◊ô◊°◊ô◊ô◊ù ◊û◊ë◊©◊® ◊ê◊ì◊ï◊ù ◊ï◊¢◊©◊ë◊ô ◊™◊ô◊ë◊ï◊ú ◊ò◊®◊ô◊ô◊ù ◊¢◊ú ◊§◊ú◊†◊¶'◊î ◊ú◊ï◊î◊ò◊™, ◊ë◊ú◊ó◊û◊†◊ô◊ô◊î ◊û◊™◊ï◊ß◊î ◊¢◊ù ◊ó◊°◊î, ◊¢◊í◊ë◊†◊ô◊î, ◊ë◊¶◊ú ◊ï◊û◊ú◊§◊§◊ï◊ü ◊ó◊û◊ï◊•", sides:["◊§◊ï◊ò◊ò◊ï ◊ê◊û◊®◊ô◊ß◊ê◊ô ◊°◊ò◊ô◊ô◊ú ◊û◊ß◊ì◊ï◊†◊ú◊ì◊°","◊ó◊®◊ì◊ú, ◊ß◊ò◊©◊ï◊§, ◊ê◊ú◊£ ◊î◊ê◊ô◊ô◊ù"], category:"◊ë◊©◊®◊ô" },
  { id:2, name:"◊î◊ï◊ò ◊ì◊ï◊í ◊ë◊® üå≠", emoji:"üå≠", color:"#E9C46A", main:"◊î◊ï◊ò ◊ì◊ï◊í ◊ë◊®", description:"◊û◊ô◊†◊ô ◊†◊ß◊†◊ô◊ß◊ô◊ï◊™ ◊ë◊ú◊ó◊û◊†◊ô◊ï◊™ ◊ë◊ê◊†◊ô◊° ◊ò◊®◊ô◊ï◊™ ◊¢◊ù ◊ó◊®◊ì◊ú, ◊ß◊ò◊©◊ï◊§, ◊¶'◊ô◊û◊ô◊¶'◊ï◊®◊ô ◊ï◊õ◊®◊ï◊ë ◊õ◊ë◊ï◊©. ◊†◊ß◊†◊ô◊ß◊ô◊ï◊™ ◊¶'◊ï◊®◊ô◊°◊ï◊° ◊ë◊í◊®◊ô◊ú ◊ï◊†◊ß◊†◊ô◊ß◊ô◊ï◊™ ◊¢◊ï◊£ ◊ß◊®◊ê◊†◊¶'◊ô◊ï◊™", sides:["◊§◊ï◊ò◊ò◊ï ◊ê◊û◊®◊ô◊ß◊ê◊ô ◊°◊ò◊ô◊ô◊ú ◊û◊ß◊ì◊ï◊†◊ú◊ì◊°","◊ó◊®◊ì◊ú, ◊ß◊ò◊©◊ï◊§, ◊ê◊ú◊£ ◊î◊ê◊ô◊ô◊ù"], category:"◊ë◊©◊®◊ô" },
  { id:3, name:"◊©◊†◊ô◊¶◊ú ◊°◊ò◊ô◊ô◊©◊ü üçó", emoji:"üçó", color:"#F4A261", main:"◊©◊†◊ô◊¶◊ú ◊°◊ò◊ô◊ô◊©◊ü", description:"◊†◊™◊ó◊ô ◊ó◊ñ◊î ◊¢◊ï◊£ ◊ë◊¶◊ô◊§◊ï◊ô ◊§◊®◊ô◊ö ◊ë◊ú◊ó◊û◊†◊ô◊ô◊™ ◊ó◊ú◊î ◊û◊™◊ï◊ß◊î ◊¢◊ù ◊û◊ò◊ë◊ï◊ó◊î ◊ó◊û◊î, ◊ò◊ë◊¢◊ï◊™ ◊ó◊¶◊ô◊ú ◊ß◊ú◊ï◊ô, ◊ó◊û◊ï◊¶◊ô ◊î◊ë◊ô◊™ ◊ï◊ò◊ó◊ô◊†◊î ◊î◊® ◊ë◊®◊õ◊î", sides:["◊§◊ï◊ò◊ò◊ï ◊ê◊û◊®◊ô◊ß◊ê◊ô ◊°◊ò◊ô◊ô◊ú ◊û◊ß◊ì◊ï◊†◊ú◊ì◊°","◊ó◊®◊ì◊ú, ◊ß◊ò◊©◊ï◊§, ◊ê◊ú◊£ ◊î◊ê◊ô◊ô◊ù"], category:"◊ë◊©◊®◊ô" },
  { id:4, name:'◊ê◊°◊ê◊ì◊ï "◊§◊ê◊ü" ◊°◊ò◊ô◊ô◊©◊ü ü•©', emoji:"ü•©", color:"#8B2500", main:'"◊§◊ê◊ü" ◊°◊ò◊ô◊ô◊©◊ü', description:"◊ú◊ó◊û◊†◊ô◊ô◊™ ◊§◊®◊†◊î ◊û◊ô◊ï◊ó◊ì◊™ ◊ï◊†◊ô◊û◊ï◊ó◊î ◊ë◊û◊ô◊ú◊ï◊ô ◊ê◊°◊ê◊ì◊ï ◊û◊§◊ï◊®◊ß ◊ï◊°◊ú◊ò ◊ß◊ï◊ú◊°◊ú◊ê◊ï ◊ê◊û◊®◊ô◊ß◊ê◊ô", sides:["◊§◊ï◊ò◊ò◊ï ◊ê◊û◊®◊ô◊ß◊ê◊ô ◊°◊ò◊ô◊ô◊ú ◊û◊ß◊ì◊ï◊†◊ú◊ì◊°","◊ó◊®◊ì◊ú, ◊ß◊ò◊©◊ï◊§, ◊ê◊ú◊£ ◊î◊ê◊ô◊ô◊ù"], category:"◊ë◊©◊®◊ô" },
  { id:5, name:"◊§◊ô◊¶◊î ◊ê◊ô◊ò◊ú◊ß◊ô◊™ üçï", emoji:"üçï", color:"#2A9D8F", main:"◊§◊ô◊¶◊î ◊°◊ò◊ô◊ô◊©◊ü", description:"◊§◊ô◊¶◊î ◊†◊ê◊§◊ï◊ú◊ô◊ò◊†◊ô◊™ 100% ◊û◊ï◊¶◊®◊ú◊î ‚Äì ◊û◊®◊í◊®◊ô◊ò◊î ◊¢◊ù ◊®◊ï◊ò◊ë ◊¢◊í◊ë◊†◊ô◊ï◊™, ◊ë◊ñ◊ô◊ú ◊ï◊û◊ï◊¶◊®◊ú◊î. ◊™◊ï◊°◊§◊ï◊™: ◊ñ◊ô◊™◊ô◊ù, ◊ë◊¶◊ú, ◊™◊ô◊®◊° ◊ï◊§◊ò◊®◊ô◊ï◊™. ◊ê◊§◊ô◊ô◊î ◊û◊ï◊ú ◊¢◊ô◊†◊ô ◊î◊ê◊ï◊®◊ó◊ô◊ù", sides:["◊†◊¶◊®◊ô ◊ô◊®◊ß◊ï◊™ ◊ë◊ß◊ï◊†◊ï◊° ‚Äì ◊í◊ñ◊®, ◊û◊ú◊§◊§◊ï◊ü, ◊©◊®◊ô, ◊™◊ô◊®◊°, ◊§◊ú◊§◊ú◊ô◊ù ◊¢◊ù ◊û◊™◊ë◊ú ◊©◊£"], category:"◊ó◊ú◊ë◊ô" },
  { id:6, name:"◊§◊ô◊© & ◊¶'◊ô◊§◊° üêü", emoji:"üêü", color:"#457B9D", main:"◊§◊ô◊© & ◊¶'◊ô◊§◊°", description:"◊†◊™◊ó◊ï◊†◊ô ◊§◊ô◊ú◊î ◊ì◊í ◊ß◊ï◊ì ◊û◊¶◊ï◊§◊ô◊ù ◊ë◊ò◊û◊§◊ï◊®◊î ◊û◊ï◊í◊©◊ô◊ù ◊ú◊¶◊ì ◊§◊ï◊ò◊ò◊ï ◊§◊®◊ô◊ö, ◊®◊ï◊ò◊ë ◊ê◊ô◊ï◊ú◊ô ◊¶'◊ô◊§◊ï◊ò◊ú◊î ◊ï◊ê◊ô◊ï◊ú◊ô ◊¶'◊ô◊ú◊ô", sides:[], category:"◊ó◊ú◊ë◊ô" },
  { id:7, name:"◊ë◊ï◊®◊ß◊° ◊®◊û◊ú◊î ü•ü", emoji:"ü•ü", color:"#6D4C41", main:"◊ë◊ï◊®◊ß◊° ◊®◊û◊ú◊î", description:"◊©◊ï◊©◊†◊ô ◊ë◊ï◊®◊ß◊° ◊ò◊ï◊®◊ß◊ô ◊ë◊ê◊§◊ô◊î ◊ò◊®◊ô◊ô◊î ◊ë◊°◊û◊ï◊ö ◊ú◊ê◊ô◊®◊ï◊¢, ◊ë◊û◊í◊ï◊ï◊ü ◊ò◊¢◊û◊ô◊ù: ◊™◊®◊ì, ◊™◊§◊ï◊ó ◊ê◊ì◊û◊î ◊ï◊í◊ë◊ô◊†◊î. ◊û◊ï◊í◊© ◊¢◊ù ◊ò◊ó◊ô◊†◊î, ◊°◊ú◊°◊î ◊§◊ô◊ß◊†◊ò◊ô◊™, ◊°◊ú◊°◊î ◊¢◊í◊ë◊†◊ô◊ï◊™ ◊™◊û◊®, ◊ß◊ï◊®◊†◊ô◊©◊ï◊ü ◊ï◊ë◊ô◊¶◊ô◊ù", sides:[], category:"◊ó◊ú◊ë◊ô" },
  { id:8, name:"◊ë◊ô◊ô◊°◊ô◊ß ‚Äì ◊©◊™◊ô◊ô◊î ◊ï◊†◊©◊†◊ï◊©◊ô◊ù üçø", emoji:"üçø", color:"#264653", main:"◊ó◊ë◊ô◊ú◊™ ◊ë◊ô◊ô◊°◊ô◊ß", description:"◊ë◊® ◊©◊™◊ô◊ô◊î + ◊†◊©◊†◊ï◊©◊ô◊ù ◊ë◊ú◊ë◊ì: ◊§◊ô◊¶◊ï◊ó◊ô◊ù, ◊†◊ê◊¶'◊ï◊°, ◊§◊ï◊§◊ß◊ï◊®◊ü ◊ï◊û◊û◊™◊ß◊ô ◊©◊ï◊ß. ◊ú◊ú◊ê ◊û◊†◊î ◊¢◊ô◊ß◊®◊ô◊™.", sides:[], category:"◊§◊®◊ï◊ï◊î" },
];

// ---------- State ----------
const ADMIN_SECRET = "dailyevents";
const isAdmin = new URLSearchParams(window.location.search).get("admin") === ADMIN_SECRET;

let state = {
  votes: {},
  voterName: "",
  hasVoted: false,
  myVote: null,
  expandedCard: null,
  loading: true,
  showResults: isAdmin, // auto-show results for admin, hidden for everyone else
  submitting: false,
};

// ---------- Storage ----------
async function fetchVotes() {
  try {
    const res = await fetch(BLOB_URL, { headers: { "Accept": "application/json" } });
    const data = await res.json();
    return data.votes || {};
  } catch(e) {
    console.error("fetchVotes error", e);
    return {};
  }
}

async function saveVotes(votes) {
  try {
    await fetch(BLOB_URL, {
      method: "PUT",
      headers: { "Content-Type": "application/json", "Accept": "application/json" },
      body: JSON.stringify({ votes })
    });
  } catch(e) {
    console.error("saveVotes error", e);
  }
}

// ---------- Helpers ----------
function getTotalVotes() {
  return Object.values(state.votes).reduce((s, arr) => s + arr.length, 0);
}
function getMenuVotes(menuId) {
  return state.votes[String(menuId)] || [];
}
function getWinner() {
  let maxV = 0, winnerId = null;
  for (const [id, voters] of Object.entries(state.votes)) {
    if (voters.length > maxV) { maxV = voters.length; winnerId = Number(id); }
  }
  return winnerId;
}

// ---------- Vote ----------
async function submitVote(menuId) {
  if (!state.voterName.trim() || state.submitting) return;
  state.submitting = true;
  render();

  const latest = await fetchVotes();
  const newVotes = { ...latest };

  if (state.myVote) {
    const pk = String(state.myVote);
    if (newVotes[pk]) {
      newVotes[pk] = newVotes[pk].filter(v => v !== state.voterName.trim());
      if (newVotes[pk].length === 0) delete newVotes[pk];
    }
  }

  const key = String(menuId);
  if (!newVotes[key]) newVotes[key] = [];
  if (!newVotes[key].includes(state.voterName.trim())) {
    newVotes[key].push(state.voterName.trim());
  }

  await saveVotes(newVotes);

  state.votes = newVotes;
  state.myVote = menuId;
  state.hasVoted = true;
  state.submitting = false;

  try {
    localStorage.setItem("my-menu-vote", JSON.stringify({ menuId, name: state.voterName.trim() }));
  } catch(e) {}

  render();
}

// ---------- Render ----------
function h(tag, attrs, ...children) {
  const el = document.createElement(tag);
  if (attrs) {
    for (const [k, v] of Object.entries(attrs)) {
      if (k === "style" && typeof v === "object") {
        Object.assign(el.style, v);
      } else if (k.startsWith("on") && typeof v === "function") {
        el.addEventListener(k.slice(2).toLowerCase(), v);
      } else if (k === "className") {
        el.className = v;
      } else if (k === "disabled") {
        el.disabled = v;
      } else {
        el.setAttribute(k, v);
      }
    }
  }
  for (const child of children.flat()) {
    if (child == null || child === false) continue;
    el.appendChild(typeof child === "string" ? document.createTextNode(child) : child);
  }
  return el;
}

// ‚îÄ‚îÄ ADMIN DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAdmin() {
  const app = document.getElementById("app");
  app.innerHTML = "";

  if (state.loading) {
    app.appendChild(
      h("div", { className: "loading-screen" },
        h("div", { className: "loading-spinner" }, "üèÄ"),
        h("p", { style: { color:"#fff", fontFamily:"inherit", marginTop:"16px" } }, "◊ò◊ï◊¢◊ü...")
      )
    );
    return;
  }

  const total = getTotalVotes();
  const winner = getWinner();

  // Header
  app.appendChild(
    h("div", { className: "header" },
      h("div", { className: "header-emoji" }, "üìä"),
      h("h1", null, "◊™◊ï◊¶◊ê◊ï◊™ ◊î◊¶◊ë◊¢◊î"),
      h("p", { className: "header-sub" }, "◊™◊ê◊ô ◊¶◊§◊ô◊ô◊î ‚Ä¢ ◊¢◊ï◊†◊™ 2025-2026"),
      h("span", { className: "header-badge" }, "üîê ◊û◊¶◊ë ◊û◊†◊î◊ú")
    )
  );

  const wrap = h("div", { className: "admin-wrap" });

  // Refresh button
  const refreshBtn = h("button", { className: "admin-refresh",
    onClick: async () => { state.votes = await fetchVotes(); renderAdmin(); }
  }, "üîÑ ◊®◊¢◊†◊ü ◊™◊ï◊¶◊ê◊ï◊™");
  wrap.appendChild(refreshBtn);

  // Total count
  wrap.appendChild(
    h("div", { className: "admin-total" },
      h("strong", null, String(total)),
      " ◊î◊¶◊ë◊¢◊ï◊™ ◊°◊î\"◊õ"
    )
  );

  if (total === 0) {
    wrap.appendChild(h("div", { className: "admin-empty" }, "‚è≥ ◊¢◊ì◊ô◊ô◊ü ◊ê◊ô◊ü ◊î◊¶◊ë◊¢◊ï◊™..."));
  } else {
    // Sort menus by vote count descending, skip zero-vote menus
    const sorted = MENUS
      .map(m => ({ menu: m, voters: getMenuVotes(m.id) }))
      .filter(x => x.voters.length > 0)
      .sort((a, b) => b.voters.length - a.voters.length);

    const maxVotes = sorted[0].voters.length;
    const RANK_ICONS = ["ü•á", "ü•à", "ü•â"];

    sorted.forEach(({ menu, voters }, idx) => {
      const pct = Math.round((voters.length / total) * 100);
      const isWinner = menu.id === winner;

      const row = h("div", { className: "admin-row" });
      if (isWinner) row.style.border = `2px solid ${menu.color}`;

      // Top row: rank ¬∑ emoji ¬∑ name ¬∑ count
      const rowTop = h("div", { className: "admin-row-top" },
        h("div", { className: "admin-rank" }, RANK_ICONS[idx] || `${idx + 1}`),
        h("div", { className: "admin-emoji" }, menu.emoji),
        h("div", { className: "admin-name" }, menu.name),
        h("div", { className: "admin-count", style: { color: menu.color } },
          `${voters.length} (${pct}%)`
        )
      );
      row.appendChild(rowTop);

      // Bar
      const barBg = h("div", { className: "admin-bar-bg" });
      const fill = h("div", { className: "admin-bar-fill" });
      fill.style.width = Math.round((voters.length / maxVotes) * 100) + "%";
      fill.style.background = `linear-gradient(90deg, ${menu.color}, ${menu.color}bb)`;
      barBg.appendChild(fill);
      row.appendChild(barBg);

      // Voter name chips
      const chips = h("div", { className: "admin-chips" },
        ...voters.map(name => {
          const chip = h("span", { className: "admin-chip" }, name);
          chip.style.borderColor = menu.color;
          chip.style.color = menu.color;
          return chip;
        })
      );
      row.appendChild(chips);

      wrap.appendChild(row);
    });
  }

  wrap.appendChild(h("div", { className: "footer" }, "Daily Events ‚Ä¢ ◊™◊ê◊ô ◊¶◊§◊ô◊ô◊î ◊¢◊ï◊†◊™ 2025-2026"));
  app.appendChild(wrap);
}

// ‚îÄ‚îÄ VOTER PAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderVoter() {
  const app = document.getElementById("app");
  app.innerHTML = "";

  if (state.loading) {
    app.appendChild(
      h("div", { className: "loading-screen" },
        h("div", { className: "loading-spinner" }, "üèÄ"),
        h("p", { style: { color: "#fff", fontFamily: "inherit", marginTop: "16px" } }, "◊ò◊ï◊¢◊ü...")
      )
    );
    return;
  }

  const total = getTotalVotes();
  const winner = getWinner();

  // Header
  const header = h("div", { className: "header" },
    h("div", { className: "header-emoji" }, "üèÄ"),
    h("h1", null, "◊™◊§◊®◊ô◊ò ◊™◊ê◊ô ◊¶◊§◊ô◊ô◊î"),
    h("p", { className: "header-sub" }, "◊¢◊ï◊†◊™ 2025-2026"),
    h("span", { className: "header-badge" }, "üî¥ ◊î◊¶◊ë◊ô◊¢◊ï ◊ú◊™◊§◊®◊ô◊ò ◊î◊û◊ï◊¢◊ì◊£ ◊¢◊ú◊ô◊õ◊ù")
  );

  // Name input / voted banner
  let nameSection;
  if (!state.hasVoted) {
    const input = h("input", {
      className: "name-input",
      type: "text",
      placeholder: "◊î◊õ◊†◊ô◊°◊ï ◊ê◊™ ◊î◊©◊ù ◊©◊ú◊õ◊ù...",
    });
    input.value = state.voterName;
    input.addEventListener("input", e => { state.voterName = e.target.value; });
    nameSection = h("div", { className: "section" },
      h("label", { className: "name-label" }, "◊û◊î ◊î◊©◊ù ◊©◊ú◊ö?"),
      input
    );
  } else {
    const votedMenu = MENUS.find(m => m.id === state.myVote);
    nameSection = h("div", { className: "voted-banner" },
      h("span", { style: { fontSize: "20px" } }, "‚úÖ"),
      h("span", null, state.voterName + ", ◊î◊¶◊ë◊¢◊™ ◊ú" + (votedMenu ? votedMenu.name : "")),
      h("span", { style: { fontSize: "12px", opacity: "0.7" } }, "(◊ê◊§◊©◊® ◊ú◊©◊†◊ï◊™ ◊ë◊ú◊ó◊ô◊¶◊î ◊¢◊ú ◊ê◊§◊©◊®◊ï◊™ ◊ê◊ó◊®◊™)")
    );
  }

  // Common items
  const common = h("div", { className: "common-banner" },
    h("div", { className: "common-title" }, "üçª ◊û◊î ◊õ◊ï◊ú◊ù ◊û◊ß◊ë◊ú◊ô◊ù?"),
    h("div", { className: "common-item" }, h("span", null, "ü•§"), " ◊©◊™◊ô◊ô◊î ◊ß◊ú◊î (◊ß◊ï◊ß◊î ◊ß◊ï◊ú◊î) + ◊ë◊ô◊®◊î ◊ß◊®◊ú◊°◊ë◊®◊í/◊ò◊ï◊ë◊ï◊®◊í"),
    h("div", { className: "common-item" }, h("span", null, "üçø"), " ◊§◊ô◊¶◊ï◊ó◊ô◊ù, ◊†◊ê◊¶'◊ï◊°, ◊§◊ï◊§◊ß◊ï◊®◊ü, ◊û◊û◊™◊ß◊ô ◊©◊ï◊ß"),
    h("div", { className: "common-item" }, h("span", null, "üç∞"), " ◊û◊ô◊ß◊° ◊§◊ò◊ô◊§◊ï◊®◊ô◊ù (◊ë◊ô◊ü ◊î◊®◊ë◊¢ ◊î-3 ◊ú-4)")
  );

  // Cards
  const grid = h("div", { className: "cards-grid" },
    ...MENUS.map(menu => {
      const menuVotes = getMenuVotes(menu.id);
      const isExpanded = state.expandedCard === menu.id;
      const isMyVote = state.myVote === menu.id;
      const isWinner = winner === menu.id && total >= 2;

      const card = h("div", {
        className: "menu-card",
        style: { border: isMyVote ? `3px solid ${menu.color}` : "3px solid transparent" }
      });

      if (isWinner) card.appendChild(h("div", { className: "winner-badge" }, "üëë ◊û◊ï◊ë◊ô◊ú"));
      if (isMyVote) {
        const mb = h("div", { className: "my-vote-badge" }, "‚úì ◊î◊ë◊ó◊ô◊®◊î ◊©◊ú◊ô");
        mb.style.background = menu.color;
        card.appendChild(mb);
      }

      const cardHeader = h("div", {
        className: "card-header",
        onClick: () => { state.expandedCard = isExpanded ? null : menu.id; renderVoter(); }
      });

      const emojiBox = h("div", { className: "menu-emoji-box" }, menu.emoji);
      emojiBox.style.background = menu.color + "15";

      const catBadge = h("span", { className: "category-badge" }, menu.category);
      catBadge.style.background = menu.color + "18";
      catBadge.style.color = menu.color;

      const expandIcon = h("button", { className: "expand-icon" }, "‚ñº");
      expandIcon.style.transform = isExpanded ? "rotate(180deg)" : "rotate(0deg)";

      cardHeader.appendChild(
        h("div", { className: "card-top" },
          emojiBox,
          h("div", { className: "card-title-area" },
            h("div", { className: "menu-name" }, menu.name),
            h("div", null, catBadge)
          ),
          expandIcon
        )
      );
      cardHeader.appendChild(h("p", { className: "main-dish" }, menu.main));
      card.appendChild(cardHeader);

      if (isExpanded) {
        card.appendChild(
          h("div", { className: "expanded-content" },
            h("div", { className: "detail-section" },
              h("div", { className: "detail-label" }, "üìã ◊™◊ô◊ê◊ï◊®"),
              h("p", { className: "detail-text" }, menu.description)
            ),
            ...(menu.sides.length > 0 ? [
              h("div", { className: "detail-section" },
                h("div", { className: "detail-label" }, "üçü ◊™◊ï◊°◊§◊ï◊™"),
                ...menu.sides.map(side => h("p", { className: "side-item" }, "‚Ä¢ " + side))
              )
            ] : [])
          )
        );
      }

      if (state.voterName.trim()) {
        const btn = h("button", {
          className: "vote-btn",
          disabled: state.submitting,
          onClick: e => { e.stopPropagation(); submitVote(menu.id); }
        }, state.submitting ? "◊©◊ï◊ú◊ó..." : isMyVote ? "‚úì ◊ë◊ó◊®◊™ ◊ë◊ê◊§◊©◊®◊ï◊™ ◊î◊ñ◊ï" : "◊î◊¶◊ë◊¢ ◊ú◊™◊§◊®◊ô◊ò ◊î◊ñ◊î üó≥Ô∏è");
        btn.style.background = isMyVote ? menu.color : `linear-gradient(135deg, ${menu.color}, ${menu.color}dd)`;
        btn.style.opacity = state.submitting ? "0.6" : "1";
        card.appendChild(btn);
      }

      return card;
    })
  );

  app.appendChild(header);
  app.appendChild(nameSection);
  app.appendChild(common);
  app.appendChild(grid);
  app.appendChild(h("div", { className: "footer" }, "Daily Events ‚Ä¢ ◊™◊ê◊ô ◊¶◊§◊ô◊ô◊î ◊¢◊ï◊†◊™ 2025-2026"));
}

function render() {
  isAdmin ? renderAdmin() : renderVoter();
}

// ---------- Init ----------
async function init() {
  render(); // show loading

  state.votes = await fetchVotes();

  try {
    const saved = localStorage.getItem("my-menu-vote");
    if (saved) {
      const parsed = JSON.parse(saved);
      state.hasVoted = true;
      state.myVote = parsed.menuId;
      state.voterName = parsed.name;
    }
  } catch(e) {}

  state.loading = false;
  render();

  // Poll every 10s
  setInterval(async () => {
    state.votes = await fetchVotes();
    render();
  }, 10000);
}

init();
</script>
</body>
</html>
